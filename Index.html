<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatnea - Connect with People Around You</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2hhdG5lYSIsInNob3J0X25hbWUiOiJDaGF0bmVhIiwiZGVzY3JpcHRpb24iOiJDb25uZWN0IHdpdGggcGVvcGxlIGFyb3VuZCB5b3UiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzY2N2VlYSIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNakFpSUdobGFXZG9kRDBpTVRJd0lqNDhjbVZqZENCNFBTSTJNQ0lnZVQwaU5qQWlJSGRwWkhSb1BTSXhNakFpSUdobGFXZG9kRDBpTVRJd0lpQm1hV3hzUFNJak5qWjNaV1ZoSWo0OEwzTjJaejQ9Iiwic2l6ZXMiOiIxMjB4MTIwIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Chatnea">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIj48cmVjdCB4PSI2MCIgeT0iNjAiIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjNjY3ZWVhIj48L3N2Zz4=">
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .logo {
            margin-bottom: 15px;
            display: inline-block;
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 10px 0;
        }

        .download-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .download-header {
            margin-bottom: 25px;
        }

        .download-header h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .download-header p {
            color: #666;
            font-size: 1rem;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .download-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            min-width: 180px;
            justify-content: center;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .pwa-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .android-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .ios-btn {
            background: linear-gradient(135deg, #007AFF, #0056CC);
            color: white;
        }

        .desktop-btn {
            background: linear-gradient(135deg, #FF6B6B, #EE5A52);
            color: white;
        }

        .already-have-app-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .already-have-app-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .download-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .feature-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .feature-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .feature-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .install-prompt {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }

        .install-prompt h4 {
            margin: 0 0 10px 0;
        }

        .install-prompt p {
            margin: 0 0 15px 0;
            opacity: 0.9;
        }

        .install-prompt-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }

        .install-prompt-btn:hover {
            background: #f0f0f0;
        }

        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: #5a6fd8;
        }

        .local-map-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .map-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .location-setup {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .location-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .location-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
        }

        .location-input button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s;
        }

        .location-input button:hover {
            background: #5a6fd8;
        }

        .location-btn {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .location-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .manual-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
            padding: 5px;
        }

        .manual-btn:hover {
            color: #5a6fd8;
        }

        .location-note {
            text-align: center;
        }

        .call-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .call-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 150px;
        }

        .voice-call-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .video-call-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.searching {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chat-area {
            background: white;
            border-radius: 15px;
            flex: 1;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .nearby-users {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
        }

        .nearby-users h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .user-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-card {
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            border: 2px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .user-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .user-card.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .call-user-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }

        .user-card:hover .call-user-btn {
            display: block;
        }

        .group-controls {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .group-btn {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .group-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .group-btn.voice {
            background: #4CAF50;
        }

        .group-btn.video {
            background: #2196F3;
        }

        .group-btn.voice:hover {
            background: #45a049;
        }

        .group-btn.video:hover {
            background: #1976D2;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-content {
            background: #f1f3f4;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.own .message-content {
            background: #667eea;
            color: white;
        }

        .message-input {
            padding: 20px;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }

        .message-input input:focus {
            border-color: #667eea;
        }

        .message-input button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .message-input button:hover {
            background: #5a6fd8;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: none;
            z-index: 3000;
            flex-direction: column;
        }

        .call-header {
            padding: 20px;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
        }

        .call-status {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .call-duration {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #333;
        }

        .local-video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid white;
            background: #333;
        }

        .call-controls {
            padding: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(0,0,0,0.7);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn.mute {
            background: #4CAF50;
            color: white;
        }

        .control-btn.mute.active {
            background: #f44336;
        }

        .control-btn.camera {
            background: #2196F3;
            color: white;
        }

        .control-btn.camera.active {
            background: #f44336;
        }

        .control-btn.hangup {
            background: #f44336;
            color: white;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .audio-call {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .audio-call .video-container {
            flex-direction: column;
            justify-content: center;
            text-align: center;
            color: white;
        }

        .audio-avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin-bottom: 20px;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .connection-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            font-size: 1.2rem;
        }

        .theme-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .theme-btn:hover {
            transform: scale(1.1);
            background: white;
        }

        .sound-toggle {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .sound-toggle:hover {
            transform: scale(1.1);
            background: white;
        }

        .sound-toggle.muted {
            background: #f44336;
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            animation: bounceIn 0.5s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-profile {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .upload-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .location-input {
                flex-direction: column;
            }
            
            .location-input input,
            .location-input button {
                width: 100%;
            }

            .local-video {
                width: 120px;
                height: 90px;
                top: 10px;
                right: 10px;
            }

            .call-controls {
                padding: 20px;
                gap: 15px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .auth-tabs {
                flex-direction: column;
            }

            .map-container {
                height: 250px;
            }

            .map-stats {
                flex-direction: column;
                gap: 10px;
            }

            .download-buttons {
                flex-direction: column;
                align-items: center;
            }

            .download-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Controls -->
    <div class="theme-controls">
        <button class="sound-toggle" id="soundToggle" title="Toggle Sound Effects">🔊</button>
        <button class="theme-btn" id="themeBtn" title="Change Background">📷</button>
    </div>

    <!-- User Profile -->
    <div class="user-profile" id="userProfile">
        <div id="profileInfo"></div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content" id="loadingContent">
            <div class="loading-spinner"></div>
            <h3 id="loadingText">Connecting to call...</h3>
            <p>Please wait while we set up your connection</p>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-content">
            <h3>Change Background Theme</h3>
            <div class="upload-area" id="uploadArea">
                <p>📷 Click here or drag & drop an image</p>
                <p style="font-size: 0.9rem; color: #666;">Supports JPG, PNG, GIF</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <div style="margin-top: 20px;">
                <button id="cancelUploadBtn" style="padding: 10px 20px; margin-right: 10px; background: #ccc; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                <button id="resetBgBtn" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Reset to Default</button>
            </div>
        </div>
    </div>

    <!-- Call Interface -->
    <div class="call-interface" id="callInterface">
        <div class="call-header">
            <div class="call-status" id="callStatus">Connecting...</div>
            <div class="call-duration" id="callDuration">00:00</div>
        </div>
        <div class="video-container" id="videoContainer">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay muted playsinline></video>
            <div class="connection-status" id="connectionStatus">Connecting to call...</div>
        </div>
        <div class="call-controls">
            <button class="control-btn mute" id="muteBtn">🎤</button>
            <button class="control-btn camera" id="cameraBtn">📹</button>
            <button class="control-btn hangup" id="hangupBtn">📞</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4facfe;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:1" />
                        </linearGradient>
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0" dy="4" stdDeviation="3" flood-color="rgba(0,0,0,0.3)"/>
                        </filter>
                    </defs>
                    
                    <circle cx="40" cy="40" r="35" fill="url(#logoGradient)" filter="url(#shadow)"/>
                    <path d="M40 15 C32 15 26 21 26 29 C26 37 40 50 40 50 S54 37 54 29 C54 21 48 15 40 15 Z" fill="white" opacity="0.9"/>
                    <circle cx="40" cy="29" r="6" fill="#667eea"/>
                    <ellipse cx="28" cy="55" rx="8" ry="6" fill="white" opacity="0.9"/>
                    <ellipse cx="52" cy="58" rx="10" ry="7" fill="white" opacity="0.8"/>
                    <circle cx="25" cy="35" r="2" fill="white" opacity="0.7"/>
                    <circle cx="55" cy="32" r="2" fill="white" opacity="0.7"/>
                    <circle cx="35" cy="65" r="2" fill="white" opacity="0.7"/>
                    <line x1="27" y1="36" x2="38" y2="42" stroke="white" stroke-width="1" opacity="0.5"/>
                    <line x1="53" y1="34" x2="42" y2="40" stroke="white" stroke-width="1" opacity="0.5"/>
                    <line x1="37" y1="63" x2="42" y2="52" stroke="white" stroke-width="1" opacity="0.5"/>
                </svg>
            </div>
            <h1>Chatnea</h1>
            <p>Connect and chat with people around you</p>
        </div>

        <!-- Download App Section -->
        <div class="download-section" id="downloadSection">
            <div class="download-header">
                <h3>📱 Download Chatnea App</h3>
                <p>Get the full experience on all your devices</p>
                <button class="already-have-app-btn" id="hideDownloadBtn">✅ I already have the app</button>
            </div>

            <div class="download-buttons">
                <button class="download-btn pwa-btn" id="pwaBtn">
                    <span>📱</span>
                    <div>
                        <div>Install Web App</div>
                        <small>Works on all devices</small>
                    </div>
                </button>
                
                <button class="download-btn android-btn" id="androidBtn">
                    <span>🤖</span>
                    <div>
                        <div>Android APK</div>
                        <small>Direct download</small>
                    </div>
                </button>
                
                <button class="download-btn ios-btn" id="iosBtn">
                    <span>🍎</span>
                    <div>
                        <div>iOS Shortcut</div>
                        <small>Add to home screen</small>
                    </div>
                </button>
                
                <button class="download-btn desktop-btn" id="desktopBtn">
                    <span>💻</span>
                    <div>
                        <div>Desktop App</div>
                        <small>Windows, Mac, Linux</small>
                    </div>
                </button>
            </div>

            <div class="install-prompt" id="installPrompt">
                <h4>📱 Install Chatnea</h4>
                <p>Add Chatnea to your home screen for quick access and offline features!</p>
                <button class="install-prompt-btn" id="installNowBtn">Install Now</button>
                <button class="install-prompt-btn" id="maybeLaterBtn" style="background: transparent; color: white; border: 1px solid white;">Maybe Later</button>
            </div>

            <div class="download-features">
                <div class="feature-item">
                    <div class="feature-icon">⚡</div>
                    <div class="feature-title">Lightning Fast</div>
                    <div class="feature-desc">Instant loading and smooth performance</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">📴</div>
                    <div class="feature-title">Works Offline</div>
                    <div class="feature-desc">Access your chats even without internet</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">🔔</div>
                    <div class="feature-title">Push Notifications</div>
                    <div class="feature-desc">Never miss a message or call</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">🔒</div>
                    <div class="feature-title">Secure & Private</div>
                    <div class="feature-desc">End-to-end encrypted conversations</div>
                </div>
            </div>

            <div class="qr-code" id="qrCode" style="display: none;">
                <canvas id="qrCanvas" width="200" height="200"></canvas>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">Scan with your phone to download</p>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Login</button>
                <button class="auth-tab" id="signupTab">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <h3 style="margin-bottom: 20px;">Welcome Back!</h3>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="auth-btn" id="loginBtn">Login</button>
            </div>

            <!-- Sign Up Form -->
            <div class="auth-form" id="signupForm">
                <h3 style="margin-bottom: 20px;">Create Account</h3>
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password">
                </div>
                <button class="auth-btn" id="signupBtn">Create Account</button>
            </div>
        </div>

        <!-- Local Area Map Section -->
        <div class="local-map-section" id="localMapSection">
            <h3 style="margin-bottom: 15px; color: #333;">📍 Your Neighborhood</h3>
            <div class="map-container" id="mapContainer"></div>
            <div class="map-stats">
                <div class="stat-item">
                    <div class="stat-number" id="chatneaUsers">0</div>
                    <div class="stat-label">Chatnea Users</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="activeCalls">0</div>
                    <div class="stat-label">Active Calls</div>
                </div>
            </div>
        </div>

        <div class="location-setup" id="locationSetup">
            <div class="location-input">
                <button id="locationBtn" class="location-btn">📍 Share My Location</button>
                <div class="manual-location" style="display: none;" id="manualLocation">
                    <input type="text" id="locationInput" placeholder="Or enter your city manually" />
                    <button id="connectManuallyBtn">Connect</button>
                </div>
            </div>
            <div class="call-buttons">
                <button id="voiceCallBtn" class="call-btn voice-call-btn">📞 Call People Nearby</button>
                <button id="videoCallBtn" class="call-btn video-call-btn">📹 Video Call Nearby</button>
            </div>
            <div id="statusMessage" class="status searching" style="display: none;">
                📍 Getting your location...
            </div>
            <div class="location-note">
                <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">We need your location to find people nearby. Your exact location is never shared with other users.</p>
                <button id="manualBtn" class="manual-btn">Enter location manually instead</button>
            </div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="nearby-users">
                <h3>👥 People Nearby</h3>
                <div class="user-list" id="userList">
                    <div class="empty-state">
                        <p>Enter your location above to find people nearby!</p>
                    </div>
                </div>
            </div>

            <div class="group-controls">
                <button class="group-btn" id="createGroupBtn">👥 Create Group Chat</button>
                <button class="group-btn voice" id="groupVoiceBtn">📞 Group Voice Call</button>
                <button class="group-btn video" id="groupVideoBtn">📹 Group Video Call</button>
            </div>

            <div class="messages" id="messages">
                <div class="empty-state">
                    <h3>💬 Start Chatting</h3>
                    <p>Select someone from the nearby users to start a conversation</p>
                </div>
            </div>

            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled />
                <button id="sendButton" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let userLocation = null;
        let activeChat = null;
        let messages = {};
        let nearbyUsers = [];
        let currentCallType = null;
        let peer = null;
        let localStream = null;
        let currentCall = null;
        let callStartTime = null;
        let callTimer = null;
        let isMuted = false;
        let isCameraOff = false;
        let soundEnabled = true;
        let localMap = null;
        let deferredPrompt = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            // Check if user was previously logged in
            const savedUser = localStorage.getItem('chatneaUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    completeAuth(currentUser);
                } catch (error) {
                    console.error('Error loading saved user:', error);
                }
            }

            // Check if download section should be hidden
            if (localStorage.getItem('chatneaDownloadHidden') === 'true') {
                hideDownloadSection();
            }

            // Load custom background if set
            const customBg = localStorage.getItem('chatneaCustomBackground');
            if (customBg) {
                document.body.style.background = `url('${customBg}') center/cover no-repeat`;
            }

            // Initialize EmailJS
            initializeEmailJS();
        });

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            hideInstallPrompt();
            alert('🎉 Chatnea has been installed! You can now access it from your home screen.');
        });

        function setupEventListeners() {
            // Auth tabs and buttons
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('signupTab').addEventListener('click', () => switchAuthTab('signup'));
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('signupBtn').addEventListener('click', signupUser);

            // Location and call buttons
            document.getElementById('locationBtn').addEventListener('click', requestLocation);
            document.getElementById('voiceCallBtn').addEventListener('click', startVoiceCall);
            document.getElementById('videoCallBtn').addEventListener('click', startVideoCall);
            document.getElementById('manualBtn').addEventListener('click', showManualInput);
            document.getElementById('connectManuallyBtn').addEventListener('click', connectManually);

            // Call control buttons
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('cameraBtn').addEventListener('click', toggleCamera);
            document.getElementById('hangupBtn').addEventListener('click', endCall);

            // Theme and sound controls
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            document.getElementById('themeBtn').addEventListener('click', openThemeUpload);
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Download buttons
            document.getElementById('hideDownloadBtn').addEventListener('click', hideDownloadSection);
            document.getElementById('pwaBtn').addEventListener('click', installPWA);
            document.getElementById('androidBtn').addEventListener('click', downloadAndroid);
            document.getElementById('iosBtn').addEventListener('click', downloadIOS);
            document.getElementById('desktopBtn').addEventListener('click', downloadDesktop);
            document.getElementById('installNowBtn').addEventListener('click', installPWA);
            document.getElementById('maybeLaterBtn').addEventListener('click', dismissInstallPrompt);

            // Upload modal
            document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('cancelUploadBtn').addEventListener('click', closeUploadModal);
            document.getElementById('resetBgBtn').addEventListener('click', resetBackground);
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Message input
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            document.getElementById('sendButton').addEventListener('click', sendMessage);

            // Group controls
            document.getElementById('createGroupBtn').addEventListener('click', createGroupChat);
            document.getElementById('groupVoiceBtn').addEventListener('click', () => startGroupCall('voice'));
            document.getElementById('groupVideoBtn').addEventListener('click', () => startGroupCall('video'));

            // File upload drag and drop
            setupFileUpload();
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload(files[0]);
                }
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        }

        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file (JPG, PNG, GIF)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                document.body.style.background = `url('${imageUrl}') center/cover no-repeat`;
                localStorage.setItem('chatneaCustomBackground', imageUrl);
                closeUploadModal();
                playSound('notification');
            };
            reader.readAsDataURL(file);
        }

        // Sound effects
        const sounds = {
            notification: createSound(800, 0.1, 'sine'),
            message: createSound(600, 0.1, 'triangle'),
            call: createSound(440, 0.2, 'square'),
            connect: createSound(1000, 0.15, 'sine'),
            disconnect: createSound(300, 0.2, 'sawtooth')
        };

        function createSound(frequency, duration, type = 'sine') {
            return function() {
                if (!soundEnabled) return;
                
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                } catch (error) {
                    console.log('Audio not supported');
                }
            };
        }

        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName]();
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggle');
            btn.textContent = soundEnabled ? '🔊' : '🔇';
            btn.classList.toggle('muted', !soundEnabled);
            
            if (soundEnabled) {
                playSound('notification');
            }
        }

        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function hideDownloadSection() {
            document.getElementById('downloadSection').style.display = 'none';
            localStorage.setItem('chatneaDownloadHidden', 'true');
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('signupTab').classList.add('active');
                document.getElementById('signupForm').classList.add('active');
            }
            
            playSound('notification');
        }

        function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                alert('Please fill in all fields!');
                return;
            }
            
            const userData = {
                name: email.split('@')[0],
                email: email,
                loginMethod: 'email'
            };
            
            completeAuth(userData);
        }

        async function signupUser() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            if (!name || !email || !password || !confirmPassword) {
                alert('Please fill in all fields!');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address!');
                return;
            }
            
            showLoadingScreen('Creating your account...');
            
            try {
                await sendWelcomeEmail(name, email);
                hideLoadingScreen();
                alert('🎉 Welcome to Chatnea! Check your email for a welcome message.');
            } catch (error) {
                hideLoadingScreen();
                console.error('Signup error:', error);
                alert('Account created successfully! Welcome to Chatnea!');
            }
            
            const userData = {
                name: name,
                email: email,
                loginMethod: 'email'
            };
            completeAuth(userData);
        }

        async function completeAuth(userData) {
            currentUser = {
                id: generateUserId(),
                name: userData.name,
                email: userData.email,
                avatar: userData.name.charAt(0).toUpperCase(),
                loginMethod: userData.loginMethod,
                lastSeen: new Date(),
                isOnline: true,
                peerId: null
            };
            
            localStorage.setItem('chatneaUser', JSON.stringify(currentUser));
            
            document.getElementById('profileInfo').innerHTML = `
                <strong>${currentUser.name}</strong><br>
                <small>${currentUser.email}</small>
            `;
            document.getElementById('userProfile').style.display = 'block';
            
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('localMapSection').style.display = 'block';
            document.getElementById('locationSetup').style.display = 'block';
            document.getElementById('chatArea').style.display = 'flex';
            
            initializePeer();
            initializeLocalMap();
            requestNotificationPermission();
            playSound('connect');
        }

        async function logout() {
            if (currentUser && userLocation) {
                const locationKey = `nearby_users_${userLocation.replace(/\s+/g, '_').toLowerCase()}`;
                let nearbyData = await loadFromStorage(locationKey) || { users: [] };
                nearbyData.users = nearbyData.users.filter(user => user.id !== currentUser.id);
                await saveToStorage(locationKey, nearbyData);
            }
            
            localStorage.removeItem('chatneaUser');
            currentUser = null;
            userLocation = null;
            
            document.getElementById('userProfile').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('localMapSection').style.display = 'none';
            document.getElementById('locationSetup').style.display = 'none';
            document.getElementById('chatArea').style.display = 'none';
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            playSound('disconnect');
        }

        function initializePeer() {
            if (peer) return;
            
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 1
            });

            peer.on('open', function(id) {
                console.log('My peer ID is: ' + id);
                currentUser.peerId = id;
            });

            peer.on('call', function(call) {
                handleIncomingCall(call);
            });

            peer.on('error', function(err) {
                console.error('PeerJS error:', err);
                currentUser.peerId = 'demo_' + Date.now();
            });
        }

        function initializeLocalMap() {
            if (localMap) return;
            
            try {
                localMap = L.map('mapContainer').setView([40.7128, -74.0060], 16);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(localMap);
                
                setInterval(updateLocalStats, 5000);
            } catch (error) {
                console.error('Map initialization failed:', error);
                document.getElementById('mapContainer').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">🗺️ Map loading...</div>';
            }
        }

        async function requestLocation() {
            const statusEl = document.getElementById('statusMessage');
            const locationBtn = document.getElementById('locationBtn');
            
            statusEl.style.display = 'block';
            statusEl.textContent = '📍 Getting your location...';
            statusEl.className = 'status searching';
            locationBtn.disabled = true;
            locationBtn.textContent = 'Getting location...';
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    });
                });
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                userLocation = `Location ${lat.toFixed(2)}, ${lng.toFixed(2)}`;
                
                statusEl.textContent = `📍 Connected in ${userLocation}`;
                statusEl.className = 'status connected';
                locationBtn.textContent = '✅ Location Set';
                
                updateMapForLocation(lat, lng, userLocation);
                await loadNearbyUsers();
                playSound('connect');
                
            } catch (error) {
                console.error('Location error:', error);
                statusEl.textContent = '❌ Location access denied. Please enter manually below.';
                statusEl.className = 'status error';
                locationBtn.disabled = false;
                locationBtn.textContent = '📍 Try Again';
                showManualInput();
            }
        }

        function showManualInput() {
            document.getElementById('manualLocation').style.display = 'flex';
        }

        async function connectManually() {
            const locationInput = document.getElementById('locationInput');
            const location = locationInput.value.trim();
            
            if (!location) {
                alert('Please enter a location!');
                return;
            }
            
            userLocation = location;
            const coords = getApproximateCoords(location);
            
            const statusEl = document.getElementById('statusMessage');
            statusEl.style.display = 'block';
            statusEl.textContent = `📍 Connected in ${userLocation}`;
            statusEl.className = 'status connected';
            
            updateMapForLocation(coords.lat, coords.lng, userLocation);
            await loadNearbyUsers();
            playSound('connect');
        }

        async function loadNearbyUsers() {
            if (!userLocation || !currentUser) return;
            
            await updateNearbyUsersInStorage(userLocation);
            nearbyUsers = await loadNearbyUsersFromStorage(userLocation);
            
            displayNearbyUsers();
            updateLocalStats();
        }

        function displayNearbyUsers() {
            const userList = document.getElementById('userList');
            
            if (nearbyUsers.length === 0) {
                userList.innerHTML = '<div class="empty-state"><p>No users found nearby. Try a different location!</p></div>';
                return;
            }
            
            userList.innerHTML = '';
            nearbyUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-avatar">${user.avatar}</div>
                    <span>${user.name}</span>
                    <button class="call-user-btn" title="Call ${user.name}">📞</button>
                `;
                
                userCard.addEventListener('click', function(e) {
                    if (e.target.classList.contains('call-user-btn')) {
                        e.stopPropagation();
                        callUser(user.id);
                    } else {
                        selectUser(user);
                    }
                });
                
                userList.appendChild(userCard);
            });
        }

        function selectUser(user) {
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('active');
            });
            
            event.target.closest('.user-card').classList.add('active');
            
            activeChat = user;
            loadMessages(user.id);
            
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').placeholder = `Message ${user.name}...`;
            
            playSound('notification');
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !activeChat) return;
            
            const filteredMessage = filterBadWords(messageText);
            
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                senderName: currentUser.name,
                recipientId: activeChat.id,
                content: filteredMessage,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            const senderKey = `chatnea_messages_${currentUser.id}_${activeChat.id}`;
            const senderMessages = await loadFromStorage(senderKey) || [];
            senderMessages.push(message);
            await saveToStorage(senderKey, senderMessages);
            
            messageInput.value = '';
            await loadMessages(activeChat.id);
            playSound('message');
        }

        async function loadMessages(userId) {
            if (!userId) return;
            
            const chatKey = `chatnea_messages_${currentUser.id}_${userId}`;
            const userMessages = await loadFromStorage(chatKey) || [];
            
            const messagesEl = document.getElementById('messages');
            messagesEl.innerHTML = '';
            
            if (userMessages.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <h3>💬 Chat with ${activeChat.name}</h3>
                    <p>Start your conversation!</p>
                `;
                messagesEl.appendChild(emptyState);
                return;
            }
            
            userMessages.forEach(msg => {
                const messageEl = document.createElement('div');
                const isOwnMessage = msg.senderId === currentUser.id;
                messageEl.className = `message ${isOwnMessage ? 'own' : ''}`;
                
                messageEl.innerHTML = `
                    <div class="user-avatar">${isOwnMessage ? currentUser.avatar : activeChat.avatar}</div>
                    <div class="message-content">${msg.content}</div>
                `;
                
                messagesEl.appendChild(messageEl);
            });
            
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Storage functions
        async function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to storage:', error);
                return false;
            }
        }

        async function loadFromStorage(key) {
            try {
                const localData = localStorage.getItem(key);
                return localData ? JSON.parse(localData) : null;
            } catch (error) {
                console.error('Error loading from storage:', error);
                return null;
            }
        }

        async function loadNearbyUsersFromStorage(location) {
            try {
                const locationKey = `nearby_users_${location.replace(/\s+/g, '_').toLowerCase()}`;
                const nearbyData = await loadFromStorage(locationKey);
                
                if (nearbyData && nearbyData.users) {
                    return nearbyData.users.filter(user => 
                        user.id !== currentUser.id && 
                        new Date(user.lastSeen) > new Date(Date.now() - 30 * 60 * 1000)
                    );
                }
                
                // Generate demo users if none exist
                return [
                    { id: 'demo1', name: 'Alice', avatar: 'A', peerId: 'demo1', lastSeen: new Date().toISOString() },
                    { id: 'demo2', name: 'Bob', avatar: 'B', peerId: 'demo2', lastSeen: new Date().toISOString() },
                    { id: 'demo3', name: 'Charlie', avatar: 'C', peerId: 'demo3', lastSeen: new Date().toISOString() },
                    { id: 'demo4', name: 'Diana', avatar: 'D', peerId: 'demo4', lastSeen: new Date().toISOString() }
                ];
            } catch (error) {
                console.error('Error loading nearby users:', error);
                return [];
            }
        }

        async function updateNearbyUsersInStorage(location) {
            if (!currentUser || !location) return;
            
            const locationKey = `nearby_users_${location.replace(/\s+/g, '_').toLowerCase()}`;
            let nearbyData = await loadFromStorage(locationKey) || { users: [] };
            
            const userIndex = nearbyData.users.findIndex(u => u.id === currentUser.id);
            const userData = {
                id: currentUser.id,
                name: currentUser.name,
                avatar: currentUser.avatar,
                location: location,
                lastSeen: new Date().toISOString(),
                isOnline: true,
                peerId: currentUser.peerId,
                inCall: currentCall !== null
            };
            
            if (userIndex >= 0) {
                nearbyData.users[userIndex] = userData;
            } else {
                nearbyData.users.push(userData);
            }
            
            nearbyData.users = nearbyData.users.filter(user => 
                new Date(user.lastSeen) > new Date(Date.now() - 10 * 60 * 1000)
            );
            
            await saveToStorage(locationKey, nearbyData);
        }

        function updateMapForLocation(lat, lng, locationName) {
            if (!localMap) return;
            
            try {
                localMap.eachLayer(function (layer) {
                    if (layer instanceof L.CircleMarker) {
                        localMap.removeLayer(layer);
                    }
                });
                
                localMap.setView([lat, lng], 16);
                
                const userMarker = L.circleMarker([lat, lng], {
                    radius: 12,
                    fillColor: '#4CAF50',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(localMap);
                
                userMarker.bindPopup(`📍 You are here in ${locationName}`);
                
                nearbyUsers.forEach(user => {
                    if (user.id !== currentUser.id) {
                        const randomLat = lat + (Math.random() - 0.5) * 0.01;
                        const randomLng = lng + (Math.random() - 0.5) * 0.01;
                        
                        const marker = L.circleMarker([randomLat, randomLng], {
                            radius: 8,
                            fillColor: '#667eea',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(localMap);
                        
                        marker.bindPopup(`${user.name} is using Chatnea nearby`);
                    }
                });
            } catch (error) {
                console.error('Map update failed:', error);
            }
        }

        function getApproximateCoords(location) {
            const locationCoords = {
                'new york': { lat: 40.7128, lng: -74.0060 },
                'london': { lat: 51.5074, lng: -0.1278 },
                'paris': { lat: 48.8566, lng: 2.3522 },
                'tokyo': { lat: 35.6762, lng: 139.6503 },
                'sydney': { lat: -33.8688, lng: 151.2093 },
                'berlin': { lat: 52.5200, lng: 13.4050 },
                'moscow': { lat: 55.7558, lng: 37.6176 },
                'beijing': { lat: 39.9042, lng: 116.4074 },
                'mumbai': { lat: 19.0760, lng: 72.8777 },
                'san francisco': { lat: 37.7749, lng: -122.4194 }
            };
            
            const key = location.toLowerCase();
            return locationCoords[key] || { lat: 40.7128, lng: -74.0060 };
        }

        function updateLocalStats() {
            const realUserCount = nearbyUsers.length + (currentUser ? 1 : 0);
            const activeCalls = nearbyUsers.filter(user => user.inCall).length;
            
            document.getElementById('chatneaUsers').textContent = realUserCount;
            document.getElementById('activeCalls').textContent = activeCalls;
        }

        // Bad words filter
        const badWords = ['fuck', 'shit', 'bitch', 'asshole', 'bastard', 'cunt', 'whore', 'slut'];

        function filterBadWords(text) {
            let filtered = text;
            badWords.forEach(word => {
                const regex = new RegExp('\\b' + word + '\\b', 'gi');
                filtered = filtered.replace(regex, '*'.repeat(word.length));
            });
            return filtered;
        }

        async function startVoiceCall() {
            currentCallType = 'voice';
            showLoadingScreen('Getting microphone access...');
            playSound('call');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                hideLoadingScreen();
                showCallInterface(false);
                document.getElementById('callStatus').textContent = 'Ready for voice calls';
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="audio-avatar">${currentUser.avatar}</div>
                    <h2>Voice Call Ready</h2>
                    <p>Click on a user to start calling</p>
                `;
            } catch (err) {
                hideLoadingScreen();
                console.error('Microphone access denied:', err);
                alert('❌ Microphone access denied. Please allow microphone access to use voice calling.');
            }
        }

        async function startVideoCall() {
            currentCallType = 'video';
            showLoadingScreen('Getting camera and microphone access...');
            playSound('call');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                hideLoadingScreen();
                showCallInterface(true);
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('callStatus').textContent = 'Ready for video calls';
                document.getElementById('connectionStatus').innerHTML = `
                    <h2>Video Call Ready</h2>
                    <p>Click on a user to start calling</p>
                `;
            } catch (err) {
                hideLoadingScreen();
                console.error('Camera/microphone access denied:', err);
                alert('❌ Camera or microphone access denied. Please allow camera and microphone access to use video calling.');
            }
        }

        function showCallInterface(isVideo) {
            const callInterface = document.getElementById('callInterface');
            
            callInterface.style.display = 'flex';
            
            if (!isVideo) {
                callInterface.classList.add('audio-call');
                document.getElementById('localVideo').style.display = 'none';
                document.getElementById('remoteVideo').style.display = 'none';
                document.getElementById('cameraBtn').style.display = 'none';
            } else {
                callInterface.classList.remove('audio-call');
                document.getElementById('localVideo').style.display = 'block';
                document.getElementById('remoteVideo').style.display = 'block';
                document.getElementById('cameraBtn').style.display = 'flex';
            }
        }

        function callUser(userId) {
            if (!peer || !localStream) {
                alert('Please start a call session first using the call buttons above.');
                return;
            }

            const user = nearbyUsers.find(u => u.id === userId);
            if (!user) {
                alert('User not found.');
                return;
            }

            playSound('call');
            document.getElementById('callStatus').textContent = `Calling ${user.name}...`;
            document.getElementById('connectionStatus').textContent = 'Connecting...';
            
            // Demo call simulation
            setTimeout(() => {
                if (Math.random() > 0.3) {
                    document.getElementById('callStatus').textContent = `Connected with ${user.name}`;
                    document.getElementById('connectionStatus').style.display = 'none';
                    startCallTimer();
                    playSound('connect');
                    alert(`📞 Demo: Connected with ${user.name}! This is a demo call.`);
                } else {
                    alert(`Could not connect to ${user.name}. They might be busy.`);
                    document.getElementById('connectionStatus').textContent = 'Call failed';
                }
            }, 2000);
        }

        function handleIncomingCall(call) {
            const callerName = 'Someone nearby';
            playSound('call');
            
            if (confirm(`${callerName} is calling you. Accept?`)) {
                if (!localStream) {
                    navigator.mediaDevices.getUserMedia({ 
                        video: currentCallType === 'video', 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    }).then(stream => {
                        localStream = stream;
                        answerCall(call);
                    }).catch(err => {
                        console.error('Failed to get media:', err);
                        call.close();
                    });
                } else {
                    answerCall(call);
                }
            } else {
                call.close();
            }
        }

        function answerCall(call) {
            currentCall = call;
            call.answer(localStream);
            
            showCallInterface(currentCallType === 'video');
            if (currentCallType === 'video') {
                document.getElementById('localVideo').srcObject = localStream;
            }
            
            call.on('stream', function(remoteStream) {
                document.getElementById('remoteVideo').srcObject = remoteStream;
                document.getElementById('callStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').style.display = 'none';
                startCallTimer();
                playSound('connect');
            });

            call.on('close', function() {
                endCall();
            });
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('callDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function toggleMute() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            const muteBtn = document.getElementById('muteBtn');
            if (isMuted) {
                muteBtn.classList.add('active');
                muteBtn.textContent = '🔇';
            } else {
                muteBtn.classList.remove('active');
                muteBtn.textContent = '🎤';
            }
            
            playSound('notification');
        }

        function toggleCamera() {
            if (!localStream || currentCallType !== 'video') return;
            
            isCameraOff = !isCameraOff;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = !isCameraOff;
            });
            
            const cameraBtn = document.getElementById('cameraBtn');
            if (isCameraOff) {
                cameraBtn.classList.add('active');
                cameraBtn.textContent = '📷';
            } else {
                cameraBtn.classList.remove('active');
                cameraBtn.textContent = '📹';
            }
            
            playSound('notification');
        }

        function endCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            document.getElementById('callInterface').style.display = 'none';
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('connectionStatus').style.display = 'block';
            
            document.getElementById('muteBtn').classList.remove('active');
            document.getElementById('muteBtn').textContent = '🎤';
            document.getElementById('cameraBtn').classList.remove('active');
            document.getElementById('cameraBtn').textContent = '📹';
            isMuted = false;
            isCameraOff = false;
            
            playSound('disconnect');
        }

        // Group functions (placeholder)
        function createGroupChat() {
            if (nearbyUsers.length === 0) {
                alert('No users nearby to invite to a group chat!');
                return;
            }
            alert('🚧 Group chat feature coming soon! For now, you can chat with individual users.');
        }

        function startGroupCall(type) {
            if (nearbyUsers.length === 0) {
                alert('No users nearby to invite to a group call!');
                return;
            }
            alert(`🚧 Group ${type} call feature coming soon! For now, you can call individual users.`);
        }

        // Utility functions
        function showLoadingScreen(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoadingScreen() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function openThemeUpload() {
            document.getElementById('uploadModal').style.display = 'flex';
            playSound('notification');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
        }

        function resetBackground() {
            document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            localStorage.removeItem('chatneaCustomBackground');
            closeUploadModal();
            playSound('notification');
        }

        // PWA Functions
        function showInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'block';
        }

        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        function dismissInstallPrompt() {
            hideInstallPrompt();
            localStorage.setItem('installPromptDismissed', 'true');
        }

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                hideInstallPrompt();
            } else {
                showManualInstallInstructions();
            }
        }

        function showManualInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = `
                    📱 To install Chatnea on iOS:
                    1. Tap the Share button (square with arrow)
                    2. Scroll down and tap "Add to Home Screen"
                    3. Tap "Add" to confirm
                `;
            } else if (isAndroid) {
                instructions = `
                    📱 To install Chatnea on Android:
                    1. Tap the menu (⋮) in your browser
                    2. Select "Add to Home screen" or "Install app"
                    3. Tap "Add" to confirm
                `;
            } else {
                instructions = `
                    💻 To install Chatnea on Desktop:
                    1. Look for the install icon (⊕) in your address bar
                    2. Click it and select "Install"
                    3. Or use browser menu > "Install Chatnea"
                `;
            }
            
            alert(instructions);
        }

        function downloadAndroid() {
            alert('🤖 Android APK: Bookmark this page and access it from your Android device to install!');
        }

        function downloadIOS() {
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                installPWA();
            } else {
                alert('🍎 iOS Installation: Open this page on your iPhone/iPad and follow the installation instructions!');
            }
        }

        function downloadDesktop() {
            if (deferredPrompt) {
                installPWA();
            } else {
                const desktopInstructions = `
                    💻 Desktop App Installation:
                    
                    Chrome/Edge:
                    • Look for the install icon (⊕) in the address bar
                    • Or go to Settings > Install Chatnea
                    
                    Firefox:
                    • Bookmark this page for quick access
                    • Or use "Add to Home Screen" from menu
                    
                    Safari:
                    • Add to Dock from File menu
                    • Or bookmark for easy access
                `;
                alert(desktopInstructions);
            }
        }

        // EmailJS initialization
        function initializeEmailJS() {
            try {
                emailjs.init("YOUR_PUBLIC_KEY"); // Replace with actual key
            } catch (error) {
                console.log('EmailJS not available');
            }
        }

        async function sendWelcomeEmail(name, email) {
            try {
                const templateParams = {
                    to_name: name,
                    to_email: email,
                    from_name: 'Chatnea Team',
                    message: `Welcome to Chatnea! We're excited to have you join our community of local connections.`
                };
                
                await emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams);
                return true;
            } catch (error) {
                console.error('Email send failed:', error);
                throw error;
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                    }
                });
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'chatnea-v1';
                    const urlsToCache = [
                        '/',
                        '/offline.html'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98b630a5d5c06c4c',t:'MTc1OTkzMjI5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
