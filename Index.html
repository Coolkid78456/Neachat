<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatnea - Connect with People Around You</title>
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .logo {
            margin-bottom: 15px;
            display: inline-block;
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 10px 0;
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: #5a6fd8;
        }

        .location-setup {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .location-btn {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .call-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .call-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 150px;
        }

        .voice-call-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .video-call-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
            display: none;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.searching {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chat-area {
            background: white;
            border-radius: 15px;
            flex: 1;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .nearby-users {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
        }

        .nearby-users h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .user-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-card {
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            border: 2px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .user-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .user-card.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .call-user-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }

        .user-card:hover .call-user-btn {
            display: block;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-content {
            background: #f1f3f4;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.own .message-content {
            background: #667eea;
            color: white;
        }

        .message-input {
            padding: 20px;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }

        .message-input input:focus {
            border-color: #667eea;
        }

        .message-input button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .message-input button:hover {
            background: #5a6fd8;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: none;
            z-index: 3000;
            flex-direction: column;
        }

        .call-header {
            padding: 20px;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
        }

        .call-status {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .call-duration {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #333;
        }

        .local-video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid white;
            background: #333;
        }

        .call-controls {
            padding: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(0,0,0,0.7);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn.mute {
            background: #4CAF50;
            color: white;
        }

        .control-btn.mute.active {
            background: #f44336;
        }

        .control-btn.camera {
            background: #2196F3;
            color: white;
        }

        .control-btn.camera.active {
            background: #f44336;
        }

        .control-btn.hangup {
            background: #f44336;
            color: white;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .audio-call {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .audio-call .video-container {
            flex-direction: column;
            justify-content: center;
            text-align: center;
            color: white;
        }

        .audio-avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin-bottom: 20px;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .connection-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            font-size: 1.2rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .call-buttons {
                flex-direction: column;
            }

            .local-video {
                width: 120px;
                height: 90px;
                top: 10px;
                right: 10px;
            }

            .call-controls {
                padding: 20px;
                gap: 15px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingText">Connecting...</h3>
            <p>Please wait while we set up your connection</p>
        </div>
    </div>

    <!-- Call Interface -->
    <div class="call-interface" id="callInterface">
        <div class="call-header">
            <div class="call-status" id="callStatus">Connecting...</div>
            <div class="call-duration" id="callDuration">00:00</div>
        </div>
        <div class="video-container" id="videoContainer">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay muted playsinline></video>
            <div class="connection-status" id="connectionStatus">Connecting to call...</div>
        </div>
        <div class="call-controls">
            <button class="control-btn mute" id="muteBtn">🎤</button>
            <button class="control-btn camera" id="cameraBtn">📹</button>
            <button class="control-btn hangup" id="hangupBtn">📞</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4facfe;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle cx="40" cy="40" r="35" fill="url(#logoGradient)"/>
                    <path d="M40 15 C32 15 26 21 26 29 C26 37 40 50 40 50 S54 37 54 29 C54 21 48 15 40 15 Z" fill="white" opacity="0.9"/>
                    <circle cx="40" cy="29" r="6" fill="#667eea"/>
                </svg>
            </div>
            <h1>Chatnea</h1>
            <p>Connect and chat with people around you</p>
        </div>

        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Login</button>
                <button class="auth-tab" id="signupTab">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <h3 style="margin-bottom: 20px;">Welcome Back!</h3>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="auth-btn" id="loginBtn">Login</button>
            </div>

            <!-- Sign Up Form -->
            <div class="auth-form" id="signupForm">
                <h3 style="margin-bottom: 20px;">Create Account</h3>
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password">
                </div>
                <button class="auth-btn" id="signupBtn">Create Account</button>
            </div>
        </div>

        <div class="location-setup" id="locationSetup">
            <h3 style="margin-bottom: 20px; color: #333;">📍 Set Your Location</h3>
            <button class="location-btn" id="locationBtn">📍 Share My Location</button>
            <div class="call-buttons">
                <button class="call-btn voice-call-btn" id="voiceCallBtn">📞 Start Voice Call</button>
                <button class="call-btn video-call-btn" id="videoCallBtn">📹 Start Video Call</button>
            </div>
            <div id="statusMessage" class="status">
                📍 Getting your location...
            </div>
            <div style="text-align: center;">
                <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">We need your location to find people nearby. Your exact location is never shared.</p>
            </div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="nearby-users">
                <h3>👥 People Nearby</h3>
                <div class="user-list" id="userList">
                    <div class="empty-state">
                        <p>Set your location above to find people nearby!</p>
                    </div>
                </div>
            </div>

            <div class="messages" id="messages">
                <div class="empty-state">
                    <h3>💬 Start Chatting</h3>
                    <p>Select someone from the nearby users to start a conversation</p>
                </div>
            </div>

            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled />
                <button id="sendButton" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let userLocation = null;
        let activeChat = null;
        let nearbyUsers = [];
        let currentCallType = null;
        let peer = null;
        let localStream = null;
        let currentCall = null;
        let callStartTime = null;
        let callTimer = null;
        let isMuted = false;
        let isCameraOff = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            // Check if user was previously logged in
            const savedUser = localStorage.getItem('chatneaUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    completeAuth(currentUser);
                } catch (error) {
                    console.error('Error loading saved user:', error);
                }
            }
        });

        function setupEventListeners() {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('signupTab').addEventListener('click', () => switchAuthTab('signup'));

            // Auth buttons
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('signupBtn').addEventListener('click', signupUser);

            // Location and call buttons
            document.getElementById('locationBtn').addEventListener('click', requestLocation);
            document.getElementById('voiceCallBtn').addEventListener('click', startVoiceCall);
            document.getElementById('videoCallBtn').addEventListener('click', startVideoCall);

            // Call control buttons
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('cameraBtn').addEventListener('click', toggleCamera);
            document.getElementById('hangupBtn').addEventListener('click', endCall);

            // Message input
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.getElementById('sendButton').addEventListener('click', sendMessage);
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('signupTab').classList.add('active');
                document.getElementById('signupForm').classList.add('active');
            }
        }

        function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                alert('Please fill in all fields!');
                return;
            }
            
            const userData = {
                name: email.split('@')[0],
                email: email,
                loginMethod: 'email'
            };
            
            completeAuth(userData);
        }

        function signupUser() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            if (!name || !email || !password || !confirmPassword) {
                alert('Please fill in all fields!');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            const userData = {
                name: name,
                email: email,
                loginMethod: 'email'
            };
            
            completeAuth(userData);
        }

        function completeAuth(userData) {
            currentUser = {
                id: generateUserId(),
                name: userData.name,
                email: userData.email,
                avatar: userData.name.charAt(0).toUpperCase(),
                loginMethod: userData.loginMethod,
                lastSeen: new Date(),
                isOnline: true,
                peerId: null
            };
            
            localStorage.setItem('chatneaUser', JSON.stringify(currentUser));
            
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('locationSetup').style.display = 'block';
            document.getElementById('chatArea').style.display = 'flex';
            
            initializePeer();
            alert(`Welcome to Chatnea, ${currentUser.name}! 🎉`);
        }

        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function initializePeer() {
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 1
            });

            peer.on('open', function(id) {
                console.log('My peer ID is: ' + id);
                currentUser.peerId = id;
            });

            peer.on('call', function(call) {
                handleIncomingCall(call);
            });

            peer.on('error', function(err) {
                console.error('PeerJS error:', err);
                currentUser.peerId = 'local_' + Date.now();
            });
        }

        async function requestLocation() {
            const statusEl = document.getElementById('statusMessage');
            const locationBtn = document.getElementById('locationBtn');
            
            statusEl.style.display = 'block';
            statusEl.textContent = '📍 Getting your location...';
            statusEl.className = 'status searching';
            locationBtn.disabled = true;
            locationBtn.textContent = 'Getting location...';
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    });
                });
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                userLocation = `Location ${lat.toFixed(2)}, ${lng.toFixed(2)}`;
                
                statusEl.textContent = `📍 Connected in ${userLocation}`;
                statusEl.className = 'status connected';
                locationBtn.textContent = '✅ Location Set';
                
                await loadNearbyUsers();
                
            } catch (error) {
                console.error('Location error:', error);
                userLocation = 'Demo Location';
                statusEl.textContent = `📍 Connected in ${userLocation}`;
                statusEl.className = 'status connected';
                locationBtn.textContent = '✅ Location Set';
                await loadNearbyUsers();
            }
        }

        async function loadNearbyUsers() {
            // Generate some demo users
            nearbyUsers = [
                { id: 'user1', name: 'Alice', avatar: 'A', peerId: 'demo1' },
                { id: 'user2', name: 'Bob', avatar: 'B', peerId: 'demo2' },
                { id: 'user3', name: 'Charlie', avatar: 'C', peerId: 'demo3' },
                { id: 'user4', name: 'Diana', avatar: 'D', peerId: 'demo4' }
            ];
            
            displayNearbyUsers();
        }

        function displayNearbyUsers() {
            const userList = document.getElementById('userList');
            
            if (nearbyUsers.length === 0) {
                userList.innerHTML = '<div class="empty-state"><p>No users found nearby. Try a different location!</p></div>';
                return;
            }
            
            userList.innerHTML = '';
            nearbyUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-avatar">${user.avatar}</div>
                    <span>${user.name}</span>
                    <button class="call-user-btn" title="Call ${user.name}">📞</button>
                `;
                
                userCard.addEventListener('click', function(e) {
                    if (e.target.classList.contains('call-user-btn')) {
                        e.stopPropagation();
                        callUser(user.id);
                    } else {
                        selectUser(user);
                    }
                });
                
                userList.appendChild(userCard);
            });
        }

        function selectUser(user) {
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('active');
            });
            
            event.target.closest('.user-card').classList.add('active');
            
            activeChat = user;
            loadMessages(user.id);
            
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').placeholder = `Message ${user.name}...`;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !activeChat) return;
            
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                senderName: currentUser.name,
                recipientId: activeChat.id,
                content: messageText,
                timestamp: new Date().toISOString()
            };
            
            // Save message locally
            const chatKey = `chatnea_messages_${currentUser.id}_${activeChat.id}`;
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            messages.push(message);
            localStorage.setItem(chatKey, JSON.stringify(messages));
            
            messageInput.value = '';
            await loadMessages(activeChat.id);
        }

        async function loadMessages(userId) {
            if (!userId) return;
            
            const chatKey = `chatnea_messages_${currentUser.id}_${userId}`;
            const userMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            const messagesEl = document.getElementById('messages');
            messagesEl.innerHTML = '';
            
            if (userMessages.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <h3>💬 Chat with ${activeChat.name}</h3>
                    <p>Start your conversation!</p>
                `;
                messagesEl.appendChild(emptyState);
                return;
            }
            
            userMessages.forEach(msg => {
                const messageEl = document.createElement('div');
                const isOwnMessage = msg.senderId === currentUser.id;
                messageEl.className = `message ${isOwnMessage ? 'own' : ''}`;
                
                messageEl.innerHTML = `
                    <div class="user-avatar">${isOwnMessage ? currentUser.avatar : activeChat.avatar}</div>
                    <div class="message-content">${msg.content}</div>
                `;
                
                messagesEl.appendChild(messageEl);
            });
            
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        async function startVoiceCall() {
            currentCallType = 'voice';
            showLoadingScreen('Getting microphone access...');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                hideLoadingScreen();
                showCallInterface(false);
                document.getElementById('callStatus').textContent = 'Voice call ready - Click on a user to call';
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="audio-avatar">${currentUser.avatar}</div>
                    <h2>🎤 Voice Call Ready</h2>
                    <p>Click on any user nearby to start calling</p>
                `;
                
            } catch (err) {
                hideLoadingScreen();
                console.error('Microphone access denied:', err);
                alert('❌ Microphone access denied. Please allow microphone access to use voice calling.');
            }
        }

        async function startVideoCall() {
            currentCallType = 'video';
            showLoadingScreen('Getting camera and microphone access...');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                hideLoadingScreen();
                showCallInterface(true);
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('callStatus').textContent = 'Video call ready - Click on a user to call';
                document.getElementById('connectionStatus').innerHTML = `
                    <h2>📹 Video Call Ready</h2>
                    <p>Click on any user nearby to start calling</p>
                `;
                
            } catch (err) {
                hideLoadingScreen();
                console.error('Camera/microphone access denied:', err);
                alert('❌ Camera or microphone access denied. Please allow camera and microphone access to use video calling.');
            }
        }

        function showCallInterface(isVideo) {
            const callInterface = document.getElementById('callInterface');
            
            callInterface.style.display = 'flex';
            
            if (!isVideo) {
                callInterface.classList.add('audio-call');
                document.getElementById('localVideo').style.display = 'none';
                document.getElementById('remoteVideo').style.display = 'none';
                document.getElementById('cameraBtn').style.display = 'none';
            } else {
                callInterface.classList.remove('audio-call');
                document.getElementById('localVideo').style.display = 'block';
                document.getElementById('remoteVideo').style.display = 'block';
                document.getElementById('cameraBtn').style.display = 'flex';
            }
        }

        function callUser(userId) {
            if (!peer || !localStream) {
                alert('Please start a call session first using the call buttons above.');
                return;
            }

            const user = nearbyUsers.find(u => u.id === userId);
            if (!user) {
                alert('User not found.');
                return;
            }

            // Demo call simulation
            document.getElementById('callStatus').textContent = `Calling ${user.name}...`;
            document.getElementById('connectionStatus').textContent = 'Connecting...';
            
            setTimeout(() => {
                if (Math.random() > 0.3) {
                    // Simulate successful connection
                    document.getElementById('callStatus').textContent = `Connected with ${user.name}`;
                    document.getElementById('connectionStatus').style.display = 'none';
                    startCallTimer();
                    alert(`📞 Demo: Connected with ${user.name}! This is a demo call.`);
                } else {
                    // Simulate failed connection
                    alert(`Could not connect to ${user.name}. They might be busy.`);
                    document.getElementById('connectionStatus').textContent = 'Call failed';
                }
            }, 2000);
        }

        function handleIncomingCall(call) {
            const accept = confirm('📞 Someone is calling you. Accept the call?');
            
            if (accept) {
                currentCall = call;
                call.answer(localStream);
                
                call.on('stream', function(remoteStream) {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    document.getElementById('callStatus').textContent = 'Connected';
                    startCallTimer();
                });
            } else {
                call.close();
            }
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('callDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function toggleMute() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            const muteBtn = document.getElementById('muteBtn');
            if (isMuted) {
                muteBtn.classList.add('active');
                muteBtn.textContent = '🔇';
            } else {
                muteBtn.classList.remove('active');
                muteBtn.textContent = '🎤';
            }
        }

        function toggleCamera() {
            if (!localStream || currentCallType !== 'video') return;
            
            isCameraOff = !isCameraOff;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = !isCameraOff;
            });
            
            const cameraBtn = document.getElementById('cameraBtn');
            if (isCameraOff) {
                cameraBtn.classList.add('active');
                cameraBtn.textContent = '📷';
            } else {
                cameraBtn.classList.remove('active');
                cameraBtn.textContent = '📹';
            }
        }

        function endCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            document.getElementById('callInterface').style.display = 'none';
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('connectionStatus').style.display = 'block';
            
            document.getElementById('muteBtn').classList.remove('active');
            document.getElementById('muteBtn').textContent = '🎤';
            document.getElementById('cameraBtn').classList.remove('active');
            document.getElementById('cameraBtn').textContent = '📹';
            isMuted = false;
            isCameraOff = false;
        }

        function showLoadingScreen(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoadingScreen() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98b61e9450494799',t:'MTc1OTkzMTU1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
